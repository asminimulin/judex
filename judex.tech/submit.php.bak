<?php

$path_to_judge_root = getenv("JUDGE_ROOT");

function parse_config($path) {
    $result = array();
    $file_handle = fopen($path, "r");
    while(!feof($file_handle)) {
        if(!$line = fgets($file_handle)) {
            break;
        }
        $values = preg_split("/[\s,]+/", $line);
        $result[$values[0]] = $values[1];
    }
    return $result;
}

function upload($submission_id, $language) {
    global $path_to_judge_root;
	$path_to_dir = $path_to_judge_root . '/' . "Submissions" . '/' . $submission_id;
	mkdir($path_to_dir, 0777, TRUE);	

    $submission_result = array();
    $submission_result["status"] = "in_queue";
    $fp = fopen($path_to_dir . '/' . "result.json", 'w');
    fwrite($fp, json_encode($array, JSON_PRETTY_PRINT));   // here it will print the array pretty
    fclose($fp);
	
    return move_uploaded_file($_FILES['uploading_file']['tmp_name'], $path_to_dir . '/' . "code" . ".cpp");
}

function submit() {
    global $path_to_judge_root;

    if(!isset($_POST)) {
        die("Nothing in POST query");
    }

    $user_id = $_POST["user_id"];
    $problem_id = $_POST["problem_id"];
    $language = $_POST["language"];

    $dbinfo = parse_config($path_to_judge_root . '/' . "conf.d" . '/' . "database.conf");

    foreach($dbinfo as $key => $val) {
        printf("<p>|$key| -> |$val|</p>");
    }

    printf("Point 1\n");
    
    $host = $dbinfo["host"];
    $username = $dbinfo["username"];
    $password = $dbinfo["dbname"];
    $dbname = $dbinfo["dbname"];

    $conn = mysqli_connect($host, $username, $password, $dbname);
    printf("Point 2\n");
    if($conn->connect_error) {
        printf("Point 3\n");
        die(0);
    	die("Connection error: " . $conn->connect_error);
    }

    printf("Point 4\n");
    
    $sql = "INSERT INTO submissions (problem_id, user_id, time, language) VALUES ($problem_id, $user_id, now(), '$language');";
    printf("sql = $sql\n");
    $inserted = $conn->query($sql);
    if(!$inserted) {
        mysqli_error($conn);
    	die("Error while inserting into submissions");
    }
    printf("Point 5\n");

    $submission_id = mysqli_fetch_array($conn->query("SELECT LAST_INSERT_ID()"))[0];
    if(!$submission_id) {
    	die("Error while getting submission_id");
    }
    printf("Point 6\n");

    if(!upload($submission_id)) {
        die("Error while uploading file");
    }
    printf("SUCCESS\n");

    setcookie("submission_id", $submission_id, time() + 100);
    header("Location: /task.php?problem_id=$problem_id");
    
}

submit();

?>
